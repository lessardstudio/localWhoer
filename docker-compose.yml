version: '3.8'

services:
  whier:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whier-app
    restart: always
    ports:
      - "127.0.0.1:3000:3000"
    environment:
      - NODE_ENV=production
    networks:
      vpn-network:
        ipv4_address: 172.20.0.10

  openvpn:
    image: kylemanna/openvpn:latest
    container_name: openvpn-server
    restart: always
    privileged: true
    ports:
      - "1194:1194/udp"
    cap_add:
      - NET_ADMIN
    volumes:
      - ./openvpn/config:/etc/openvpn
    networks:
      vpn-network:
        ipv4_address: 172.20.0.5
    sysctls:
      - net.ipv4.ip_forward=1
    command: ovpn_run

  # Дополнительные сервисы в вашей локальной сети
  samba:
    image: dperson/samba:latest
    container_name: file-server
    restart: always
    environment:
      - USERID=1000
      - GROUPID=1000
      - SHARE=shared;/shared;yes;no;no;all;none
    volumes:
      - ./shared:/shared
    networks:
      vpn-network:
        ipv4_address: 172.20.0.20
    ports:
      - "127.0.0.1:445:445"

  dns:
    image: strm/dnsmasq:latest
    container_name: local-dns
    restart: always
    cap_add:
      - NET_ADMIN
    volumes:
      - ./dns/dnsmasq.conf:/etc/dnsmasq.conf
    networks:
      vpn-network:
        ipv4_address: 172.20.0.2
    ports:
      - "127.0.0.1:53:53/udp"

networks:
  vpn-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
