version: '3.8'

services:
  whier:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whier-app
    restart: always
    ports:
      - "127.0.0.1:3000:3000"
    environment:
      - NODE_ENV=production
    networks:
      vpn-network:
        ipv4_address: 172.20.0.10

  fastapi:
    build:
      context: ./fastapi
      dockerfile: Dockerfile
    container_name: fastapi-server
    restart: always
    ports:
      - "0.0.0.0:8000:8000"
    volumes:
      - ./openvpn:/app/openvpn
      - ./fastapi/app:/app
      - /var/run/docker.sock:/var/run/docker.sock  # Для управления Docker
    environment:
      - PYTHONUNBUFFERED=1
      - API_KEY=${API_KEY:-secret-api-key-change-me}
      - OPENVPN_DIR=/app/openvpn
    networks:
      vpn-network:
        ipv4_address: 172.20.0.30
    depends_on:
      - openvpn

  openvpn:
    image: kylemanna/openvpn:latest
    container_name: openvpn-server
    restart: always
    privileged: true
    ports:
      - "1194:1194/udp"
    cap_add:
      - NET_ADMIN
    volumes:
      - ./openvpn/config:/etc/openvpn
    networks:
      vpn-network:
        ipv4_address: 172.20.0.5
    sysctls:
      - net.ipv4.ip_forward=1
    command: ovpn_run

  samba:
    image: dperson/samba:latest
    container_name: file-server
    restart: always
    environment:
      - USERID=1000
      - GROUPID=1000
      - SHARE=shared;/shared;yes;no;no;all;none
    volumes:
      - ./shared:/shared
    networks:
      vpn-network:
        ipv4_address: 172.20.0.20
    ports:
      - "127.0.0.1:445:445"

  dns:
    image: strm/dnsmasq:latest
    container_name: local-dns
    restart: always
    cap_add:
      - NET_ADMIN
    volumes:
      - ./dns/dnsmasq.conf:/etc/dnsmasq.conf
    networks:
      vpn-network:
        ipv4_address: 172.20.0.2
    ports:
      - "127.0.0.1:53:53/udp"

  # База данных для API (опционально)
  postgres:
    image: postgres:15-alpine
    container_name: postgres-db
    restart: always
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=${DB_PASSWORD:-change-me}
      - POSTGRES_DB=vpn_management
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      vpn-network:
        ipv4_address: 172.20.0.40
    ports:
      - "127.0.0.1:5432:5432"

networks:
  vpn-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

volumes:
  postgres-data:
